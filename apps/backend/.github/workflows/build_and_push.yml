#name: Build and Push FastAPI
#
#on:
#  push:
#    branches: [master, dev]
#    tags: ['v*']
#    # Professional touch: Only trigger if files in the api or shared packages change
#    paths:
#      - 'apps/backend/**'
#      - 'packages/**'
#      - '.github/workflows/build_and_deploy.yml'
#
#jobs:
#  build-api:
#    # Syntax: {owner}/{repo}/.github/workflows/{filename}@{ref}
#    uses: daviekaranja/workflows/.github/workflows/docker-build-push.yml@master
#    with:
#      image_name: "everything-api"
#      # We set context to root ('.') so Docker can see 'packages/' if needed
#      build_context: "./apps/backend"
#      # We point specifically to the Dockerfile inside the api folder
#      dockerfile_path: "./Dockerfile"
#    secrets: inherit
#
#
#
#name: Build and Push FastAPI
#
#on:
#  push:
#    branches: [master, dev]
#    tags: ['v*']
#    paths:
#      - 'apps/backend/**'
#      - 'packages/**'
#      - '.github/workflows/build_and_deploy.yml'
#
#jobs:
#  # --- JOB 1: Build the Image ---
#  build-api:
#    uses: daviekaranja/workflows/.github/workflows/docker-build-push.yml@master
#    with:
#      image_name: "everything-api"
#      build_context: "./apps/backend"
#      dockerfile_path: "./Dockerfile"
#    secrets: inherit
#
#  # --- JOB 2: Deploy to VPS ---
#  deploy-api:
#    needs: build-api  # Only runs if the build job finishes successfully
#    # Only deploy if pushing to master or a version tag
#    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')
#    uses: daviekaranja/workflows/.github/workflows/reusable-deploy.yml@master
#    with:
#      target_directory: "/docker_stack/everythingke"
#      # github.ref_name will be 'master', 'dev', or 'v1.0.0'
#      image_tag: ${{ github.ref_name }}
#    secrets:
#      VPS_HOST: ${{ secrets.VPS_HOST }}
#      VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
#      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}




name: Build and Push FastAPI

on:
  push:
    branches: [master, dev]
    tags: ['v*']
    paths:
      - 'apps/backend/**'
      - 'packages/**'
      - '.github/workflows/build_and_deploy.yml'

jobs:
  # --- JOB 1: Build the Image ---
  build-api:
    uses: daviekaranja/workflows/.github/workflows/docker-build-push.yml@master
    with:
      image_name: "everything-api"
      build_context: "./apps/backend"
      dockerfile_path: "./Dockerfile"
    secrets: inherit

  # --- JOB 2: Deploy to VPS ---
  deploy-api:
    needs: build-api
    # Logic: Deploy on master branch OR any tag starting with 'v'
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v')
    uses: daviekaranja/workflows/.github/workflows/reusable-deploy.yml@master
    with:
      target_directory: "/docker_stack/everythingke"
      image_tag: ${{ github.ref_name }}
    secrets:
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USERNAME: ${{ secrets.VPS_USERNAME }}
      VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
