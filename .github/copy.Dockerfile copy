FROM python:3.12-slim

LABEL authors="Davie Karanja"

WORKDIR /app

ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    && rm -rf /var/lib/apt/lists/*

# 1. Copy requirements from the monorepo context
COPY apps/backend/requirements.txt .

# 2. Install dependencies
RUN pip install --no-cache-dir -r requirements.txt && pip install gunicorn

# 3. Copy backend source code PRESERVING the folder structure
# We copy the content into a folder named 'app' or keep the 'apps/backend' structure
# To fix your specific import 'from app.lib...', the code MUST be in a folder named 'app'
# Copy the backend source code while preserving the 'app' package identity
COPY apps/backend/app ./app
COPY apps/backend/alembic ./alembic
COPY apps/backend/alembic.ini .
# COPY apps/backend/main.py .
COPY apps/backend/entrypoint.sh .

# Crucial: Ensure the 'app' directory is in the python path
ENV PYTHONPATH=/app

RUN chmod +x entrypoint.sh


EXPOSE 8000

# Set PYTHONPATH so the 'app' module is discoverable from the root
ENTRYPOINT ["./entrypoint.sh"]
